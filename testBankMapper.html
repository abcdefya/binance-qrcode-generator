<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tìm kiếm ngân hàng</title>
  <script src="https://cdn.jsdelivr.net/npm/fuzzball@2.0.0/dist/fuzzball.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
    <h1 class="text-2xl font-bold mb-4 text-center">Tìm kiếm ngân hàng</h1>
    <input
      type="text"
      id="searchInput"
      placeholder="Nhập tên ngân hàng (VD: VietinBank, VCB, Công thương)"
      class="w-full p-2 mb-4 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
    />
    <div id="result" class="text-sm"></div>
  </div>

  <script>
    // Danh sách ngân hàng
    const bankList = {
    "VietinBank": {
        "id": 17,
        "name": "Ngân hàng TMCP Công thương Việt Nam",
        "code": "ICB",
        "bin": "970415",
        "logo": "https://api.vietqr.io/img/ICB.png",
        "transferSupported": 1,
        "lookupSupported": 1,
        "short_name": "VietinBank",
        "support": 3,
        "isTransfer": 1,
        "swift_code": "ICBVVNVX",
        "keywords": ["VietinBank", "Vietin", "Công thương", "Cong thuong", "ICB", "Vietin Bank"]
    }
};

    // Hàm chuẩn hóa tiếng Việt (chuyển có dấu thành không dấu)
    function removeDiacritics(str) {
      return str
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/đ/g, 'd')
        .replace(/Đ/g, 'D')
        .toLowerCase();
    }

    // Tiền xử lý dữ liệu ngân hàng
    const bankData = Object.entries(bankList).map(([key, value]) => {
      const searchableText = removeDiacritics(
        [value.name, value.short_name, value.code, ...value.keywords].join(' ')
      );
      return {
        key,
        name: value.name,
        short_name: value.short_name,
        bin: value.bin,
        code: value.code,
        searchableText
      };
    });

    // Hàm tách và lọc từ khóa từ chuỗi đầu vào
    function preprocessQuery(query) {
      // Loại bỏ ký tự đặc biệt và tách thành từ
      const cleanedQuery = query.replace(/[\(\)\[\]\,]/g, ' ').trim();
      const tokens = cleanedQuery.split(/\s+/).map(removeDiacritics).filter(token => 
        token && !['nh', 'tmcp', 'ngan', 'hang', 'thuong', 'mai', 'co', 'phan'].includes(token)
      );
      return tokens;
    }

    // Hàm tìm kiếm ngân hàng
    function searchBank(query) {
      if (!query) return null;
      const tokens = preprocessQuery(query);
      if (tokens.length === 0) return null;

      // Tìm kiếm chính xác
      for (const bank of bankData) {
        const normalizedBankFields = [
          bank.short_name.toLowerCase(),
          bank.code.toLowerCase(),
          ...bank.searchableText.split(' ')
        ];
        for (const token of tokens) {
          if (normalizedBankFields.some(field => field === token)) {
            return {
              name: bank.name,
              short_name: bank.short_name,
              bin: bank.bin,
              code: bank.code
            };
          }
        }
      }

      // Tìm kiếm mờ với fuzzball.js
      const options = { scorer: fuzzball.partial_ratio, returnObjects: true };
      let bestMatch = null;
      let highestScore = 0;

      for (const token of tokens) {
        const results = fuzzball.extract(token, bankData, { key: 'searchableText', ...options });
        if (results.length > 0 && results[0].score > 85) {
          if (results[0].score > highestScore) {
            highestScore = results[0].score;
            bestMatch = results[0].obj;
          }
        }
      }

      if (bestMatch) {
        return {
          name: bestMatch.name,
          short_name: bestMatch.short_name,
          bin: bestMatch.bin,
          code: bestMatch.code
        };
      }

      return null;
    }

    // Xử lý sự kiện input
    const searchInput = document.getElementById('searchInput');
    const resultDiv = document.getElementById('result');

    searchInput.addEventListener('input', () => {
      const query = searchInput.value;
      const result = searchBank(query);

      if (result) {
        resultDiv.innerHTML = `
          <div class="p-4 bg-gray-50 rounded">
            <p><strong>Tên ngân hàng:</strong> ${result.name}</p>
            <p><strong>Tên viết tắt:</strong> ${result.short_name}</p>
            <p><strong>Bin:</strong> ${result.bin}</p>
            <p><strong>Code:</strong> ${result.code}</p>
          </div>
        `;
      } else {
        resultDiv.innerHTML = `
          <p class="text-red-500">Không tìm thấy ngân hàng. Vui lòng thử lại với từ khóa khác (VD: VietinBank, VCB, Tiên Phong).</p>
        `;
      }
    });
  </script>
</body>
</html>